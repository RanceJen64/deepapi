# Prompts 整合说明

## 整合日期
2025-11-03

## 整合目标
将 `prompts_discord.py` 和 `prompts_final.py` 的优点整合到新版 `prompts_discord.py` 中，创建一个**专注于纯粹故事文本输出**的创意写作/角色扮演 prompts 系统。

## 最终定位：创意写作/角色扮演专用

**核心理念：深度思考在内，纯粹故事在外**

- **内部过程**：三阶段深度分析（角色/世界/历史/意图）
- **外部输出**：纯粹的故事文本（对话、叙事、场景描写）
- **绝对禁止**：分析性标题、元评论、打破第四面墙
- **适用场景**：SillyTavern、角色扮演、创意写作对话生成

---

## 主要改进

### 1. 核心 Prompt：DEEP_THINK_PROMPT

#### **采用的结构**
- **内部思考框架**：采用 discord 版的三阶段框架（分析 → 综合 → 执行）
- **输出格式**：采用 final 版的三段式结构（Understanding & Analysis → Deep Dive → Synthesis & Conclusion）

#### **整合的核心原则**
合并了两个版本的优点：

| 原则 | 来源 | 说明 |
|------|------|------|
| Story-First Outcomes | final | 不暴露内部思考过程 |
| Voice and POV Fidelity | final | 避免 OOC，保持视角一致 |
| Character and World Consistency | final | 尊重设定和连续性 |
| Emotional Arc and Pacing | final | 连贯的情感轨迹 |
| Concrete, Specific Prose | final | 具体描写胜于抽象标签 |
| 四维度分析（角色/世界/历史/意图）| discord | 系统化的上下文分析 |
| 创意综合与风险识别 | discord + final | 识别潜在的 OOC/POV/节奏问题 |
| 浑然天成的执行哲学 | discord | 让输出看起来自然流畅 |

#### **三阶段深度思考框架**

**第一阶段：深度上下文分析（内部思考，不输出）**
- 角色预设理解（含认知边界判断）
- 世界书整合（确保规则一致性）
- 对话历史解析（时间线和因果关系）
- 用户意图洞察（确定输出类型）

**第二阶段：创意综合与风险识别**
- 综合目标：角色真实性、自然融入设定、有机发展
- 风险识别：OOC、记忆漂移、POV 泄露、节奏问题、基调不一致、陈词滥调

**第三阶段：结构化执行与输出**
- 按三段式结构输出（Understanding & Analysis, Deep Dive, Synthesis & Conclusion）
- 每个部分都有明确的子项和检查清单

---

### 2. 改进 Prompt：SELF_IMPROVEMENT_PROMPT

#### **整合改进**
分为三个层面的审查：

1. **故事层面**：OOC、POV、情感弧线、声音保真度
2. **文笔层面**：具体描写、节奏、"展示而非告知"、小说而非游戏
3. **逻辑层面**：逻辑漏洞、遗漏考虑、不正确假设

#### **优势**
- 比 discord 版更系统化（三个层面）
- 比 final 版更详细（增加逻辑层面）
- 明确要求"让正文看起来像小说而非游戏脚本"

---

### 3. 验证 Prompt：VERIFICATION_SYSTEM_PROMPT

#### **整合改进**
专注于创意写作质量评估：

**问题分类更精准：**

| 问题类型 | 具体内容 | 来源 |
|---------|---------|------|
| Critical Flaw | OOC、设定破坏、认知边界违规、情感跳跃、POV 违规 | final + 增强 |
| Weak Execution | 陈词滥调、告知而非展示、情感转场不足、节奏问题 | final + discord |
| Minor Issue | 句子节奏、组织清晰度、错失的意象机会 | final |

**审查重点：**
- 角色一致性
- 情感弧线
- 认知边界（既检查"知道不该知道的"，也检查"缺乏常识性知识"）
- POV 稳定性
- 文笔质量
- 叙事逻辑

#### **优势**
- 比原 discord 版更专业（专注创意写作）
- 比 final 版更全面（增加了陈词滥调、节奏等检查）
- 提供具体的例子格式

---

### 4. 最终总结 Prompt：FINAL_SUMMARY_PROMPT

#### **整合改进**
明确输出决策逻辑：

```
输出决策：
- 如果用户请求 narrative/draft：仅输出精美的故事文本
- 如果用户请求 analysis/critique：提供结构化分析和具体例子
- 如果用户请求 revision：展示改进版本并简要说明关键变化
```

#### **优势**
- 比 discord 版更清晰（明确三种输出类型）
- 比 final 版更具体（对每种输出类型有明确指导）
- 强调保持沉浸感和角色一致性

---

### 5. 辅助函数改进

所有辅助函数都添加了详细的 docstring，说明其创意写作专用的特性：

- `build_verification_prompt`：强调创意写作审查重点
- `build_initial_thinking_prompt`：说明可接受角色卡、世界书等上下文
- `build_final_summary_prompt`：明确用于创意写作输出
- `build_thinking_plan_prompt`：保持兼容性

---

## 整合策略总结

### 采用 discord 版的优点
1. ✅ 三阶段深度思考框架（分析 → 综合 → 执行）
2. ✅ 四维度上下文分析（角色/世界/历史/意图）
3. ✅ "浑然天成"的执行哲学
4. ✅ 格式处理协议（SillyTavern JSON 格式）
5. ✅ 创意自由的态度

### 采用 final 版的优点
1. ✅ 结构化的三段式输出格式
2. ✅ 更严格的质量控制标准
3. ✅ 专业的 OOC/POV/认知边界检查
4. ✅ 清晰的问题分类系统
5. ✅ 具体的检查清单

### 新增的改进
1. ✅ 风险识别机制（在第二阶段）
2. ✅ 三层面的改进审查（故事/文笔/逻辑）
3. ✅ 明确的输出决策逻辑
4. ✅ 更详细的函数文档
5. ✅ 中英文混合的清晰说明

---

## 使用建议

### 适用场景
- ✅ SillyTavern 角色扮演对话生成
- ✅ 创意写作草稿和修改
- ✅ 叙事文本的质量分析
- ✅ 角色一致性检查
- ✅ 情感弧线评估

### 与现有系统的兼容性
- ✅ 保持与 `engine/deep_think.py` 的 API 兼容
- ✅ 保留所有原有的 constant 名称（DEEPTHINK_PROMPT, DEEP_THINK_INITIAL_PROMPT）
- ✅ 所有辅助函数签名保持不变
- ✅ EXTRACT_DETAILED_SOLUTION_MARKER 保持为 "Deep Dive"

---

## 对比原版的主要变化

### prompts_discord.py（原版）→ 新版

| 方面 | 原版 | 新版 |
|------|------|------|
| 思考框架 | 三阶段（分析→综合→执行） | **保留** + 增加风险识别 |
| 输出结构 | 无明确结构 | **新增**三段式结构 |
| 质量标准 | 基本标准 | **强化**详细检查清单 |
| OOC 检查 | 提及但不详细 | **详细**列出检查项 |
| 认知边界 | 未明确提及 | **新增**明确检查 |
| 陈词滥调 | 未特别强调 | **强调**减少陈词滥调 |

### prompts_final.py → 新版

| 方面 | final 版 | 新版 |
|------|----------|------|
| 思考框架 | 无明确框架 | **新增**三阶段框架 |
| 上下文分析 | 基本提及 | **新增**四维度分析 |
| 输出结构 | 三段式 | **保留** |
| 质量标准 | 详细 | **保留** + 补充 |
| 创作自由度 | 较保守 | **增强**创作自由 |
| 浑然天成哲学 | 未提及 | **新增** |

---

## 后续建议

### 可能的优化方向
1. 根据实际使用反馈调整风险识别的粒度
2. 可能需要为不同类型的创作（对话 vs. 叙事 vs. 分析）创建子变体
3. 考虑添加更多具体的例子和反例
4. 可能需要针对不同的模型（o1 vs. o2 vs. gemini）调整参数

### 测试建议
1. 用实际的 SillyTavern 场景测试
2. 对比新旧版本的输出质量
3. 检查是否有 OOC 行为的减少
4. 评估情感弧线的连贯性
5. 测试不同输出类型的效果

---

## 总结

这次整合成功地将两个版本的优点结合在一起：

- **Discord 版的自由创作精神** + **Final 版的质量控制严谨性**
- **系统化的内部思考流程** + **结构化的外部输出格式**
- **深度的上下文分析** + **明确的风险识别**

新版本既保持了创意的自由度，又提供了专业的质量保障，特别适合 SillyTavern 等角色扮演和创意写作场景。

---

## 重要调整记录（2025-11-03 后续）

### 调整原因
用户反馈指出这是**创意写作/角色扮演专用**的 prompts，最终应该只输出纯粹的故事文本，而不是带有分析结构的输出。

### 主要变更

#### 1. 第三阶段：从"结构化输出"改为"纯粹故事输出"

**之前（结构化）：**
```
第三阶段：结构化执行与输出
- Understanding & Analysis
- Deep Dive (with Brief Plan, Draft, Quality Checks)
- Synthesis & Conclusion
```

**现在（纯粹故事）：**
```
第三阶段：无缝执行与纯粹故事输出
- 直接输出故事文本
- 不要任何分析性标题或元评论
- 保持完全的角色沉浸感
```

#### 2. FINAL_SUMMARY_PROMPT：强化"纯粹故事输出"

**关键变更：**
- 明确标注"这是故事生成 Prompt，不是分析 Prompt"
- 绝对禁止输出 "Understanding & Analysis"、"Deep Dive" 等分析性结构
- 添加正确/错误输出示例对比
- 强调"用户想看故事，不想看分析"

#### 3. 所有相关 Prompts 保持一致

| Prompt | 变更重点 |
|--------|---------|
| SELF_IMPROVEMENT_PROMPT | 直接输出改进后的故事，不要元评论 |
| CORRECTION_PROMPT | 直接输出修改后的故事，不要修改说明 |
| VERIFICATION_SYSTEM_PROMPT | 检查是否为纯粹故事文本，是否有元评论 |
| VERIFICATION_REMINDER | 增加格式检查：是否为纯粹故事？有无分析标题？ |

#### 4. 辅助函数 Docstrings 更新

所有辅助函数的文档字符串都更新为强调"故事生成"而非"分析"：
- `build_verification_prompt`: 检查故事文本质量
- `build_initial_thinking_prompt`: 内部思考，但最终输出故事
- `build_final_summary_prompt`: 指导生成纯粹故事文本

### 核心设计理念

```
┌─────────────────────────────────────────┐
│         内部深度思考（不可见）            │
│                                         │
│  阶段1: 四维度分析                       │
│  - 角色预设理解                          │
│  - 世界书整合                            │
│  - 对话历史解析                          │
│  - 用户意图洞察                          │
│                                         │
│  阶段2: 创意综合与风险识别                │
│  - OOC/POV/节奏风险                     │
│                                         │
│  阶段3: 执行准备                         │
│  - 确定叙事策略                          │
│  - 选择场景元素                          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         外部纯粹输出（用户可见）          │
│                                         │
│  她推开门的瞬间，房间里的对话戛然而止。   │
│  三双眼睛齐刷刷地转向门口...            │
│                                         │
│  "抱歉，我来得不是时候？"她尽量让        │
│  声音听起来轻松，但指尖微微攥紧了         │
│  门把手。                                │
│                                         │
│  （纯粹的故事文本，无任何元评论）         │
└─────────────────────────────────────────┘
```

### 与 prompts_final.py 的区别

| 方面 | prompts_discord.py（本文件） | prompts_final.py |
|------|---------------------------|-----------------|
| 输出格式 | 纯粹故事文本 | 结构化分析（Understanding/Deep Dive/Synthesis） |
| 适用场景 | SillyTavern 角色扮演、创意写作对话 | 创意写作分析、批评、修改建议 |
| 用户期望 | 读到沉浸式的故事 | 看到专业的分析和建议 |
| 元评论 | 绝对禁止 | 允许（在分析部分） |
| 思考过程 | 完全隐藏 | 部分展示（Understanding & Analysis） |

### 最佳实践建议

#### 使用本文件（prompts_discord.py）当：
- ✅ 在 SillyTavern 中进行角色扮演对话
- ✅ 生成创意小说片段
- ✅ 需要沉浸式的叙事体验
- ✅ 用户角色与 AI 角色的对话互动

#### 使用 prompts_final.py 当：
- ✅ 需要分析现有创意写作作品
- ✅ 需要修改建议和改进方案
- ✅ 需要系统化的写作批评
- ✅ 学习创意写作技巧

### 更新文件清单

```
✅ prompts/prompts_discord.py - 调整为纯粹故事输出（659 行）
✅ prompts/INTEGRATION_NOTES.md - 更新整合说明
✅ 无 linting 错误
✅ API 兼容性保持（函数签名未变）
✅ 所有 Prompts 保持内部一致性
```

